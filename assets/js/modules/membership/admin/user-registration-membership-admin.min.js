!function(e,a){if(UR_Snackbar)var i=new UR_Snackbar;e(".user-membership-enhanced-select2").select2();var t={append_spinner:function(e){if(e&&e.append){return e.append('<span class="ur-spinner is-active"></span>'),!0}return!1},prepend_spinner:function(e){if(e&&e.prepend){return e.prepend('<span class="ur-spinner is-active"></span>'),!0}return!1},remove_spinner:function(e){return!(!e||!e.remove)&&(e.find(".ur-spinner").remove(),!0)},if_empty:function(e,a){return null===e||undefined===e||""===e?a:e},toggleSaveButtons:function(a){a=t.if_empty(a,!0),e(".ur-membership-save-btn").prop("disabled",!!a)},show_success_message:function(e){return!!i&&(i.add({type:"success",message:e,duration:5}),!0)},show_failure_message:function(e){return!!i&&(i.add({type:"failure",message:e,duration:6}),!0)},convert_to_timestamp:function(e,a){var i;switch(a){case"day":i=864e5;break;case"week":i=6048e5;break;case"month":i=2592e6;break;case"year":i=31536e6;break;default:return null}return(new Date).getTime()+e*i},regular_validation:function(i,s,r){return i.every(function(i){var n=e(i),l=n.val(),o=n.attr("required"),p=n.attr("type"),u=n.data("key-name");if(o&&""===l){s=!1;var m=("paypal"===r?a.labels.i18n_paypal:"")+a.labels.i18n_error+"! "+u+" "+a.labels.i18n_field_is_required+" "+("paypal"===r?a.labels.i18n_paypal_setup_error:"");return t.show_failure_message(m),!1}return!("url"===p&&!t.url_validations(l))||(s=!1,t.show_failure_message(a.labels.i18n_error+"! "+u+" "+a.labels.i18n_valid_url_field_validation+" "+u),!1)}),s},url_validations:function(e){return new RegExp("^https?:\\/\\/(?:www\\.)?[-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b(?:[-a-zA-Z0-9()@:%_\\+.~#?&\\/=]*)$").test(e)},handle_bulk_delete_action:function(i){Swal.fire({title:'<img src="'+a.delete_icon+'" id="delete-user-icon">'+a.labels.i18n_prompt_title,html:'<p id="html_1">'+a.labels.i18n_prompt_bulk_subtitle+"</p>",showCancelButton:!0,confirmButtonText:a.labels.i18n_prompt_delete,cancelButtonText:a.labels.i18n_prompt_cancel,allowOutsideClick:!1}).then(function(r){if(r.isConfirmed){var n=i.find('input[name="membership[]"]:checked'),l=[];if(n.length<1)return void t.show_failure_message(a.labels.i18n_prompt_no_membership_selected);n.each(function(){""!==e(this).val()&&l.push(e(this).val())}),s.send_data({action:"user_registration_membership_delete_memberships",membership_ids:JSON.stringify(l)},{success:function(e){e.success?(t.show_success_message(e.data.message),s.remove_deleted_memberships(n,!0)):t.show_failure_message(e.data.message)},failure:function(e,i){t.show_failure_message(a.labels.network_error+"("+i+")")},complete:function(){window.location.reload()}})}})}},s={prepare_membership_data:function(){var i={},t={},s=e("#ur-membership-create-form"),r=tinyMCE.get("ur-input-type-membership-description").getContent();if(r=r.replace(/(<img[^>]*?)(")([^>]*?>)/g,function(e,a,i,t){return a+"'"+t.replace(/"/g,"'")}),i={name:s.find("#ur-input-type-membership-name").val(),description:r,status:s.find("#ur-membership-status").prop("checked")},a.membership_id&&(i.ID=a.membership_id),t.type=s.find('input[name="ur_membership_type"]:checked').val(),t.cancel_subscription=s.find('input[name="ur_membership_cancel_on"]:checked').val(),t.role=s.find("#ur-input-type-membership-role").find(":selected").val(),"free"!==t.type){"paid"!==t.type&&(t.subscription={value:s.find("#ur-membership-duration-value").val(),duration:s.find("#ur-membership-duration").val()},t.trial_status=s.find("#ur-membership-trial-status").val(),"on"===t.trial_status&&(t.trial_data={value:s.find("#ur-membership-trial-duration-value").val(),duration:s.find("#ur-membership-trial-duration").val()}),t.cancel_subscription=s.find('input[name="ur_membership_cancel_on"]:checked').val()),t.amount=s.find("#ur-membership-amount").val();var n=s.find("#ur-membership-pg-paypal:checked").val(),l=s.find("#ur-membership-pg-bank:checked").val(),o=s.find("#ur-membership-pg-stripe:checked").val(),p=s.find("#ur-membership-pg-authorize:checked").val(),u=s.find("#ur-membership-pg-mollie:checked").val();t.payment_gateways={paypal:{status:"off"},stripe:{status:"off"},bank:{status:"off"},authorize:{status:"off"},mollie:{status:"off"}},n&&(t.payment_gateways.paypal={status:n,email:s.find("#ur-input-type-paypal-email").val(),mode:s.find("#ur-membership-paypal-mode").val(),payment_type:s.find("#ur-membership-paypal-payment-type").val(),cancel_url:s.find("#ur-input-type-cancel-url").val(),return_url:s.find("#ur-input-type-return-url").val()},"subscription"===t.type&&(t.payment_gateways.paypal.client_id=s.find("#ur-input-type-client-id").val(),t.payment_gateways.paypal.client_secret=s.find("#ur-input-type-client-secret").val())),l&&(t.payment_gateways.bank={status:l}),o&&(t.payment_gateways.stripe={status:o}),p&&(t.payment_gateways.authorize={status:p}),u&&(t.payment_gateways.mollie={status:u})}return t.upgrade_settings={upgrade_action:s.find("#ur-membership-upgrade-action").is(":checked"),upgrade_path:s.find("#ur-input-type-membership-upgrade-path").val(),upgrade_type:s.find(".urm-upgrade-path-type-container").find('input[name="ur_membership_upgrade_type"]:checked').val()},{post_data:i,post_meta_data:t}},validate_membership_form:function(){var i=e("#ur-membership-plan-and-price-section"),s=e("#ur-membership-main-fields").find("input"),r=e("#ur-membership-create-form"),n=e("#ur-membership-upgrade-action").is(":checked"),l=!0;s=Object.values(s).reverse().slice(2);var o=t.regular_validation(s,!0,"form");if(!o)return!1;var p=i.find('input[name="ur_membership_type"]:checked').val(),u=i.find("#ur-membership-amount").val();if("paid"===p||"subscription"===p){u<=0&&(l=!1,t.show_failure_message(a.labels.i18n_error+"! "+a.labels.i18n_valid_amount_field_validation));if("on"===e("#ur-membership-trial-status").val()&&"subscription"===p){var m=e("#ur-membership-trial-duration").val(),c=e("#ur-membership-trial-duration-value").val(),_=e("#ur-membership-duration").val(),d=e("#ur-membership-duration-value").val();t.convert_to_timestamp(parseInt(c,10),m)>=t.convert_to_timestamp(parseInt(d,10),_)&&(l=!1,t.show_failure_message(a.labels.i18n_error+"! "+a.labels.i18n_valid_trial_period_field_validation)),d<1&&(l=!1,t.show_failure_message(a.labels.i18n_error+"! "+a.labels.i18n_valid_min_subs_period_field_validation)),c<1&&(l=!1,t.show_failure_message(a.labels.i18n_error+"! "+a.labels.i18n_valid_min_trial_period_field_validation))}var h=!1;e("#payment-gateway-container .user-registration-switch").each(function(a,i){e(i).find("input").is(":checked")&&(h=!0)}),h||(l=!1,t.show_failure_message(a.labels.i18n_error+"! "+a.labels.i18n_pg_validation_error));if(r.find("#ur-membership-pg-paypal:checked").val()){var f=e("#paypal-section"),b=f.find("input");if("subscription"!==p)b=f.find("input").not('[name^="ur_membership_client_"]'),b=Object.values(b).reverse().slice(2).reverse(),(o=t.regular_validation(b,!0,"paypal"))||(l=!1);else{var g=f.find("#ur-input-type-client-id").val(),v=f.find("#ur-input-type-client-secret").val();""!==g&&""!==v||(l=!1,t.show_failure_message(a.labels.i18n_paypal+" "+a.labels.i18n_error+"! "+a.labels.i18n_paypal_client_secret_id_error))}}}if(n){var y=e("#ur-input-type-membership-upgrade-path"),w=e(".urm-upgrade-path-type-container"),k=w.find('input[name="ur_membership_upgrade_type"]:checked').val();y.val().length<1&&(l=!1,t.show_failure_message(a.labels.i18n_error+"! "+y.data("key-name")+" "+a.labels.i18n_field_is_required)),k===undefined&&(l=!1,t.show_failure_message(a.labels.i18n_error+"! "+w.data("key-name")+" "+a.labels.i18n_field_is_required))}return l},create_membership:function(i){if(t.toggleSaveButtons(!0),t.append_spinner(i),this.validate_membership_form()){var s=this.prepare_membership_data();this.send_data({action:"user_registration_membership_create_membership",membership_data:JSON.stringify(s)},{success:function(s){s.success?(a.membership_id=s.data.membership_id,i.text(a.labels.i18n_save),t.show_success_message(s.data.message),e(location).attr("href",a.membership_page_url)):t.show_failure_message(s.data.message)},failure:function(e,i){t.show_failure_message(a.labels.network_error+"("+i+")")},complete:function(){t.remove_spinner(i),t.toggleSaveButtons(!1)}})}else t.remove_spinner(i),t.toggleSaveButtons(!1)},update_membership:function(e){if(t.toggleSaveButtons(!0),t.append_spinner(e),this.validate_membership_form()){var i=this.prepare_membership_data();this.send_data({action:"user_registration_membership_update_membership",membership_data:JSON.stringify(i),membership_id:a.membership_id},{success:function(e){e.success?t.show_success_message(e.data.message):t.show_failure_message(e.data.message)},failure:function(e,i){t.show_failure_message(a.labels.network_error+"("+i+")")},complete:function(){t.remove_spinner(e),t.toggleSaveButtons(!1)}})}else t.remove_spinner(e),t.toggleSaveButtons(!1)},update_membership_status:function(i){t.prepend_spinner(i.parents(".row-actions")),i.attr("disabled",!0);var s=i.prop("checked"),r=i.data("ur-membership-id");this.send_data({action:"user_registration_membership_update_membership_status",membership_data:JSON.stringify({status:s,ID:r})},{success:function(e){e.success?t.show_success_message(e.data.message):t.show_failure_message(e.data.message)},failure:function(e,i){t.show_failure_message(a.labels.network_error+"("+i+")")},complete:function(){t.remove_spinner(i.parents(".row-actions")),i.attr("disabled",!1);var a=s?"Active":"Inactive",n=e("#ur-membership-list-status-"+r);n.text(a),"Inactive"===a?(n.removeClass("user-registration-badge--success-subtle"),n.addClass("user-registration-badge--secondary-subtle")):(n.removeClass("user-registration-badge--secondary-subtle"),n.addClass("user-registration-badge--success-subtle"))}})},validate_payment_gateway:function(i){var s=i.closest(".user-registration-switch"),r=i.attr("id").split("ur-membership-pg-")[1],n=e("input:radio[name=ur_membership_type]:checked").val();t.prepend_spinner(s),this.send_data({action:"user_registration_membership_validate_pg",pg:r,membership_type:n},{success:function(e){e.status?(i.prop("checked",!0),i.closest(".user-registration-switch").closest(".ur-payment-option-header").siblings(".payment-option-body").hide()):(t.show_failure_message(e.message),i.prop("checked",!1),i.closest(".user-registration-switch").closest(".ur-payment-option-header").siblings(".payment-option-body").show())},failure:function(e,i){t.show_failure_message(a.labels.network_error+"("+i+")")},complete:function(){t.remove_spinner(s),t.toggleSaveButtons(!1)}})},send_data:function(i,t){var s="function"==typeof t.success?t.success:function(){},r="function"==typeof t.failure?t.failure:function(){},n="function"==typeof t.beforeSend?t.beforeSend:function(){},l="function"==typeof t.complete?t.complete:function(){};!i._wpnonce&&a&&(i._wpnonce=a._nonce),e.ajax({type:"post",dataType:"json",url:a.ajax_url,data:i,beforeSend:n,success:s,error:r,complete:l})},remove_deleted_memberships:function(a,i){i?a.each(function(){e(this).parents("tr").remove()}):e(a).parents("tr").remove()}};e(document).on("click","input:radio[name=ur_membership_type]",function(){var a=e(this).val(),i=e("#paid-plan-container"),t=e(".ur-membership-subscription-field-container"),s=e("#payment-gateway-container"),r=e('label.ur-membership-upgrade-types[for="ur-membership-upgrade-type-pro-rata"]');i.addClass("ur-d-none"),i.addClass("ur-d-none"),s.addClass("ur-d-none"),r.addClass("ur-d-none"),t.show(),"free"!==a&&("paid"===a?t.hide():t.removeClass("ur-d-none"),r.removeClass("ur-d-none"),s.removeClass("ur-d-none"),i.removeClass("ur-d-none"))}),e(document).on("click","#ur-membership-upgrade-action",function(){e("#upgrade-settings-container").toggle(),e("input:radio[name=ur_membership_type]:checked").trigger("click")}),e(document).on("keydown",function(a){a.ctrlKey&&"s"===a.key&&(a.preventDefault(),e(".ur-membership-save-btn").trigger("click"))}),e(".ur-membership-save-btn").on("click",function(i){i.preventDefault(),i.stopPropagation();var r=e(this);e(this).find(".ur-spinner.is-active").length?t.show_failure_message(a.labels.i18n_previous_save_action_ongoing):a.membership_id&&""!==a.membership_id?s.update_membership(r):s.create_membership(r)}),e("#ur-membership-trial-status").on("click",function(){var a=e(this).prop("checked"),i=e(".trial-container");e(this).val("on"),a||e(this).val("off"),i.toggleClass("ur-d-none")}),e(".ur-membership-change-status").on("change",function(){s.update_membership_status(e(this))}),e(document).on("click",".ur-payment-option-header",function(){e(this).find("input").trigger("click")}),e(document).on("click",".pg-switch",function(a){a.stopImmediatePropagation(),e(this).is(":checked")&&e(this).closest(".user-registration-switch").find(".ur-spinner.is-active").length<1&&s.validate_payment_gateway(e(this))}),e(".delete-membership").on("click",function(i){i.preventDefault(),i.stopPropagation();var r=e(this),n=r.data("membership-id"),l=r.closest(".delete");l.find("span").hasClass("is-active")||(t.append_spinner(l),Swal.fire({title:'<img src="'+a.delete_icon+'" id="delete-user-icon">'+a.labels.i18n_prompt_title,html:'<p id="html_1">'+a.labels.i18n_prompt_single_subtitle+"</p>",showCancelButton:!0,confirmButtonText:a.labels.i18n_prompt_delete,cancelButtonText:a.labels.i18n_prompt_cancel,allowOutsideClick:!1}).then(function(e){e.isConfirmed?s.send_data({action:"user_registration_membership_delete_membership",membership_id:n},{success:function(e){e.success?(t.show_success_message(e.data.message),s.remove_deleted_memberships(r,!1)):Swal.fire({title:'<img src="'+a.delete_icon+'" id="delete-user-icon">'+a.labels.i18n_prompt_title,html:e.data.message,confirmButtonText:a.labels.i18n_prompt_ok,allowOutsideClick:!1})},failure:function(e,i){t.show_failure_message(a.labels.network_error+"("+i+")")},complete:function(){t.remove_spinner(r.closest(".delete"))}}):t.remove_spinner(r.closest(".delete"))}))}),e("#membership-list #doaction,#doaction2").on("click",function(a){a.preventDefault(),a.stopPropagation();var i=e("#membership-list");switch(i.find("select#bulk-action-selector-top option:selected").val()){case"delete":t.handle_bulk_delete_action(i)}})}(jQuery,window.ur_membership_localized_data);