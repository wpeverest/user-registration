!function(e){"use strict";var t={conditions:[],contentTargets:[],accessControl:"access",membershipId:0,conditionCounter:0,targetCounter:0,ruleData:null,initialized:!1,init:function(){var t=this;if("undefined"!=typeof urcr_membership_access_data){urcr_membership_access_data.membership_id&&(t.membershipId=parseInt(urcr_membership_access_data.membership_id,10));var r=null;if(void 0!==window.urcrMembershipRuleData&&window.urcrMembershipRuleData)r=window.urcrMembershipRuleData;else{var i=e("#ur-membership-access-section");if(i.length){var a=i.attr("data-rule-data");a&&(r=JSON.parse(a))}}var n=e(".urcr-conditions-list"),o=e(".urcr-target-type-group"),s=n.find(".urcr-condition-wrapper").length>0,c=o.find(".urcr-target-item").length>0;s||c?t.syncFromExistingHTML():r?(t.ruleData=r,t.populateRuleData(r)):t.initializeEmptyRule(),t.bindEvents(),t.initSelect2(),t.initActionSection(),t.initialized=!0}},initializeEmptyRule:function(){var e=this;e.membershipId>0&&e.addCondition("membership",!0,[e.membershipId.toString()])},syncFromExistingHTML:function(){var t=this;e(".urcr-condition-wrapper").each(function(){var r=e(this),i=r.data("condition-id"),a=r.find(".urcr-condition-field-select"),n=r.find(".urcr-condition-value-input"),o=a.val()||"roles",s="multiselect",c=t.getConditionOptions().find(function(e){return e.value===o});c&&(s=c.type||"multiselect");var l="";if("multiselect"===s){var d=n.attr("data-value");if(d)try{l=JSON.parse(d)}catch(e){l=[]}else l=[]}else if("checkbox"===s)l=n.find('input[type="radio"]:checked').val()||"logged-in";else if("date"===s||"number"===s||"text"===s)l=n.val()||"";else if("period"===s){l={select:n.find('[data-period-part="select"]').val()||"During",input:n.find('[data-period-part="input"]').val()||""}}t.conditions.push({id:i,type:o,value:l,isLocked:!1}),"multiselect"===s&&t.initConditionSelect2(i,s,l)}),e(".urcr-target-item").each(function(){var r=e(this),i=r.data("target-id"),a=r.find(".urcr-target-type-label"),n="",o=a.length?a.text().toLowerCase():"";if(-1!==o.indexOf("pages"))n="pages";else if(-1!==o.indexOf("posts"))n="posts";else if(-1!==o.indexOf("post type"))n="post_types";else if(-1!==o.indexOf("taxonomy"))n="taxonomy";else if(-1!==o.indexOf("whole site"))n="whole_site";else{var s=r.find(".urcr-content-target-input");s.length&&(n=s.data("content-type")||s.data("field-type")||""),!n&&r.find("span").length&&-1!==r.text().indexOf("Whole Site")&&(n="whole_site")}var c="";if("whole_site"===n)c="whole_site";else if("taxonomy"===n){var l=r.find(".urcr-taxonomy-select").val()||"",d=r.find(".urcr-content-target-input").attr("data-value"),u=[];if(d)try{u=JSON.parse(d)}catch(e){u=[]}c={taxonomy:l,value:u}}else{var p=r.find(".urcr-content-target-input").attr("data-value");if(p)try{c=JSON.parse(p)}catch(e){c=[]}else c=[]}t.contentTargets.push({id:i,type:n,value:c}),"whole_site"!==n&&setTimeout(function(){t.initContentTargetSelect2(i,n,c)},100)})},populateRuleData:function(t){var r=this;if(e(".urcr-conditions-list").empty(),e(".urcr-target-type-group").empty(),r.conditions=[],r.contentTargets=[],t.access_control?(r.accessControl=t.access_control,r.updateAccessControlClass()):(r.accessControl="access",r.updateAccessControlClass()),t.logic_map&&t.logic_map.conditions&&t.logic_map.conditions.length>0){var i=t.logic_map.conditions;i.sort(function(e,t){return"membership"===e.type?-1:"membership"===t.type?1:0}),i.forEach(function(e,t){var a=i[0],n=a&&"membership"===a.type&&0===t,o=e.value;Array.isArray(o)||"object"==typeof o&&null!==o||(o=o||""),r.addCondition(e.type,n,o,e.id)})}else r.membershipId>0&&r.addCondition("membership",!0,[r.membershipId.toString()]);t.target_contents&&t.target_contents.length>0&&t.target_contents.forEach(function(e){var t=e.type;"wp_pages"===t&&(t="pages"),"wp_posts"===t&&(t="posts");var i=e.value||("whole_site"===t?"whole_site":[]);"taxonomy"===t?e.taxonomy?i={taxonomy:e.taxonomy,value:Array.isArray(e.value)?e.value:[]}:"object"!=typeof e.value||null===e.value||Array.isArray(e.value)||e.value.taxonomy&&(i={taxonomy:e.value.taxonomy,value:Array.isArray(e.value.value)?e.value.value:[]}):"whole_site"!==t&&(Array.isArray(i)||(i=i?[i]:[])),r.addContentTarget(t,i,e.id)})},bindEvents:function(){var t=this;e(document).on("click",".urcr-add-condition-button",function(e){e.preventDefault(),t.addCondition("roles",!1,"")}),e(document).on("keydown",".urcr-add-condition-button",function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t.addCondition("roles",!1,""))}),e(document).on("click",".urcr-condition-remove",function(r){r.preventDefault();var i=e(this).closest(".urcr-condition-wrapper").data("condition-id");t.removeCondition(i)}),e(document).on("change",".urcr-condition-field-select",function(){var r=e(this).closest(".urcr-condition-wrapper").data("condition-id"),i=e(this).val();t.updateConditionType(r,i)}),e(document).on("change",".urcr-condition-value-input",function(){var r=e(this).closest(".urcr-condition-wrapper");if(r.length){var i=r.data("condition-id");t.updateConditionValue(i,e(this))}}),e(document).on("change",".urcr-period-input-group input, .urcr-period-input-group select",function(){var r=e(this).closest(".urcr-condition-wrapper");if(r.length){var i=r.data("condition-id"),a=e(this).closest(".urcr-period-input-group"),n={select:a.find('[data-period-part="select"]').val()||"During",input:a.find('[data-period-part="input"]').val()||""},o=t.conditions.find(function(e){return e.id===i});o&&(o.value=n)}}),e(document).on("click",".urcr-add-content-button",function(r){r.preventDefault(),t.showContentTypeDropdown(e(this))}),e(document).on("click",".urcr-target-remove",function(r){r.preventDefault();var i=e(this).closest(".urcr-target-item").data("target-id");t.removeContentTarget(i)}),e(document).on("click",".urcr-content-type-option",function(r){if(r.preventDefault(),!e(this).hasClass("urcr-dropdown-option-disabled")&&"true"!==e(this).attr("aria-disabled")){var i=e(this).data("content-type");t.addContentTarget(i),e(".urcr-content-type-dropdown-menu").removeClass("ur-d-flex").addClass("ur-d-none")}}),e(document).on("keydown",".urcr-content-type-option",function(r){if(!e(this).hasClass("urcr-dropdown-option-disabled")&&"true"!==e(this).attr("aria-disabled")&&("Enter"===r.key||" "===r.key)){r.preventDefault();var i=e(this).data("content-type");t.addContentTarget(i),e(".urcr-content-type-dropdown-menu").removeClass("ur-d-flex").addClass("ur-d-none")}}),e(document).on("click",function(t){e(t.target).closest(".urcr-content-dropdown-wrapper").length||e(t.target).closest(".urcr-add-content-button").length||e(".urcr-content-type-dropdown-menu").removeClass("ur-d-flex").addClass("ur-d-none")}),e(document).on("change",".urcr-action-type-select",function(){var r=e(this).val()||"message";t.handleActionTypeChange(r)}),e(document).on("change",'input[name="urcr-membership-message-type"]',function(){var t=e(this).val(),r=e(".urcrra-message-input-container");if(e('input[name="urcr-membership-message-type"]').closest(".urcr-checkbox-radio-option").removeClass("is-checked"),e(this).closest(".urcr-checkbox-radio-option").addClass("is-checked"),"global"===t)r.removeClass("ur-d-flex").addClass("ur-d-none"),r.hide();else if("custom"===t){r.removeClass("ur-d-none").addClass("ur-d-flex"),r.show();var i="",a=e("#urcr-membership-action-message");if("undefined"!=typeof wp&&wp.editor&&a.length){var n=window.tinymce&&window.tinymce.get("urcr-membership-action-message");i=n?n.getContent():wp.editor.getContent("urcr-membership-action-message")}else i=a.val()||"";if(!i||""===i.trim()){var o="";"undefined"!=typeof urcr_membership_access_data&&urcr_membership_access_data.membership_default_message&&(o=urcr_membership_access_data.membership_default_message),o&&setTimeout(function(){if(a.length){var e=window.tinymce&&window.tinymce.get("urcr-membership-action-message");e?e.setContent(o):wp.editor.setContent("urcr-membership-action-message",o)}else a.val(o)},100)}}})},addCondition:function(t,r,i,a){var n=this;if(t||(t="roles"),"membership"!==t){a||(a="x"+Date.now()+"_"+n.conditionCounter++);var o=n.getConditionOptions();if(o&&0!==o.length){var s=o.find(function(e){return e.value===t});s||(s=o[0],t=s.value);var c=s.type||"multiselect",l=!1,d=n.getConditionRowHtml(a,t,s.label,c,i||"",l),u=e(".urcr-conditions-list");0!==u.length&&(u.append(d),n.initConditionSelect2(a,c,i),n.conditions.push({id:a,type:t,value:i||"",isLocked:l}))}}},getConditionRowHtml:function(e,t,r,i,a,n){var o=this.getConditionOptions(),s="";n||(s='<button type="button" class="button button-link-delete urcr-condition-remove" aria-label="Remove condition"><span class="dashicons dashicons-no-alt"></span></button>');var c='<select class="urcr-condition-field-select urcr-condition-value-input"'+(n?" disabled":"")+">";o.forEach(function(e){var r=e.value===t?"selected":"";c+='<option value="'+e.value+'" '+r+">"+e.label+"</option>"}),c+="</select>";var l=this.getConditionValueInputHtml(e,i,t,a,n);return'<div class="urcr-condition-wrapper" data-condition-id="'+e+'"><div class="urcr-condition-row ur-d-flex ur-mt-2 ur-align-items-start"><div class="urcr-condition-only ur-d-flex ur-align-items-start"><div class="urcr-condition-selection-section ur-d-flex ur-align-items-center ur-g-4"><div class="urcr-condition-field-name">'+c+'</div><div class="urcr-condition-operator"><span>is</span></div><div class="urcr-condition-value">'+l+"</div></div></div></div>"+s+"</div>"},getConditionValueInputHtml:function(t,r,i,a,n){var o="",s=n?" disabled":"";if("ur_form_field"===i){var c="";a&&"object"==typeof a&&(c=a.form_id||"",a.form_fields||[]);var l=a?JSON.stringify(a):'{"form_id":"","form_fields":[]}',d=' data-value="'+e("<div>").text(l).html()+'"',u=urcr_membership_access_data.ur_forms||{};for(var p in o='<div class="urcr-ur-form-field-condition" data-condition-id="'+t+'"'+d+">",o+='<div class="urcr-form-selection ur-d-flex ur-align-items-center ur-g-4 ur-mb-2">',o+='<select class="urcr-form-select components-select-control__input urcr-condition-value-input"'+s+">",o+='<option value="">Select a form</option>',u){if(u.hasOwnProperty(p))o+='<option value="'+p+'" '+(p===c?"selected":"")+">"+u[p]+"</option>"}o+="</select>",o+="</div>",o+='<div class="urcr-form-fields-list"></div>',o+="</div>"}else if("multiselect"===r)o='<select class="urcr-enhanced-select2 urcr-condition-value-input" multiple data-condition-id="'+t+'" data-field-type="'+i+'" '+s+"></select>";else if("checkbox"===r){var m="logged-out"===a||"logged_out"===a?"checked":"";o='<div class="urcr-checkbox-radio-input"><label><input type="radio" name="condition_'+t+'_user_state" value="logged-in" '+("logged-in"===a||"logged_in"===a||""===a?"checked":"")+" "+s+"> "+(urcr_membership_access_data.labels.logged_in||"Logged In")+'</label><label><input type="radio" name="condition_'+t+'_user_state" value="logged-out" '+m+" "+s+"> "+(urcr_membership_access_data.labels.logged_out||"Logged Out")+"</label></div>"}else if("date"===r)o='<input type="date" class="urcr-condition-value-input" data-condition-id="'+t+'" data-field-type="'+i+'" value="'+(a||"")+'" '+s+">";else if("period"===r){var f="During",h="";a&&"object"==typeof a?(f=a.select||"During",h=a.input||""):a&&"object"==typeof a&&a.value&&(h=a.value||"",f="During"),o='<div class="urcr-period-input-group ur-d-flex ur-align-items-center" style="gap: 8px;"><select class="urcr-period-select urcr-condition-value-input" data-condition-id="'+t+'" data-field-type="'+i+'" data-period-part="select" '+s+'><option value="During" '+("During"===f?"selected":"")+'>During</option><option value="After" '+("After"===f?"selected":"")+'>After</option></select><input type="number" class="urcr-period-number urcr-condition-value-input" data-condition-id="'+t+'" data-field-type="'+i+'" data-period-part="input" value="'+h+'" min="0" placeholder="Days" '+s+"></div>"}else o="number"===r?'<input type="number" class="urcr-condition-value-input" data-condition-id="'+t+'" data-field-type="'+i+'" value="'+(a||"")+'" '+s+">":'<input type="text" class="urcr-condition-value-input" data-condition-id="'+t+'" data-field-type="'+i+'" value="'+(a||"")+'" '+s+">";return o},initConditionSelect2:function(t,r,i){var a=e('.urcr-condition-wrapper[data-condition-id="'+t+'"] .urcr-enhanced-select2');if("ur_form_field"===r||e('.urcr-condition-wrapper[data-condition-id="'+t+'"] .urcr-ur-form-field-condition').length)this.initURFormFieldCondition(t,i);else if(a.length&&"multiselect"===r){var n=a.data("field-type"),o=this.getSelect2Options(n);a.hasClass("select2-hidden-accessible")&&a.select2("destroy"),setTimeout(function(){a.select2({data:o,multiple:!0,width:"100%"});var e=i,t=a.attr("data-value");if(t)try{e=JSON.parse(t)}catch(t){e=i}e&&Array.isArray(e)&&e.length>0?a.val(e).trigger("change"):e&&!Array.isArray(e)&&a.val([e]).trigger("change")},100)}},initURFormFieldCondition:function(t,r){var i=this,a=e('.urcr-condition-wrapper[data-condition-id="'+t+'"] .urcr-ur-form-field-condition');if(a.length){var n="",o=[],s=a.attr("data-value");if(s)try{var c=JSON.parse(s);n=c.form_id||"",o=c.form_fields||[]}catch(e){r&&"object"==typeof r&&(n=r.form_id||"",o=r.form_fields||[])}else r&&"object"==typeof r&&(n=r.form_id||"",o=r.form_fields||[]);var l=a.find(".urcr-form-select"),d=a.find(".urcr-form-fields-list");n&&(l.val(n),i.renderFormFields(d,n,o,t)),l.off("change").on("change",function(){var r=e(this).val();r?(i.renderFormFields(d,r,[{field_name:"",operator:"is",value:""}],t),i.updateURFormFieldValue(t)):(d.empty(),i.updateURFormFieldValue(t))})}},renderFormFields:function(e,t,r,i){var a=this;if(e.empty(),t&&urcr_membership_access_data.ur_form_data&&urcr_membership_access_data.ur_form_data[t]){var n=urcr_membership_access_data.ur_form_data[t],o=[];for(var s in n)n.hasOwnProperty(s)&&o.push({value:s,label:n[s]||s});0===r.length&&(r=[{field_name:"",operator:"is",value:""}]),r.forEach(function(t,r){a.renderFormFieldRow(e,t,r,o,i)})}},renderFormFieldRow:function(t,r,i,a,n){var o=this,s=r.field_name||"",c=r.operator||"is",l=r.value||"",d='<div class="urcr-form-field-row ur-d-flex ur-align-items-center ur-mb-2"><div class="urcr-form-field-name"><select class="components-select-control__input urcr-condition-value-input urcr-form-field-select"><option value="">Select field</option>';a.forEach(function(e){var t=e.value===s?"selected":"";d+='<option value="'+e.value+'" '+t+">"+e.label+"</option>"}),d+='</select></div><div class="urcr-form-field-operator"><select class="components-select-control__input urcr-condition-value-input urcr-form-field-operator-select"><option value="is"'+("is"===c?" selected":"")+'>is</option><option value="is not"'+("is not"===c?" selected":"")+'>is not</option><option value="empty"'+("empty"===c?" selected":"")+'>empty</option><option value="not empty"'+("not empty"===c?" selected":"")+">not empty</option></select></div>","empty"!==c&&"not empty"!==c&&(d+='<div class="urcr-form-field-value ur-flex-1"><input type="text" class="components-text-control__input urcr-condition-value-input urcr-condition-value-text urcr-form-field-value-input" value="'+(l||"")+'" placeholder="Enter value"></div>'),d+='<button type="button" class="button urcr-add-field-button" aria-label="Add field"><span class="dashicons dashicons-plus-alt2"></span></button><button type="button" class="button urcr-remove-field-button" aria-label="Remove field"><span class="dashicons dashicons-minus"></span></button></div>',t.append(d);var u=t.find(".urcr-form-field-row").last();u.find(".urcr-form-field-select, .urcr-form-field-operator-select, .urcr-form-field-value-input").off("change input").on("change input",function(){o.updateURFormFieldValue(n)}),u.find(".urcr-form-field-operator-select").off("change").on("change",function(){var t=e(this).val(),r=u.find(".urcr-form-field-value");"empty"===t||"not empty"===t?r.remove():r.length||(u.find(".urcr-form-field-operator").after('<div class="urcr-form-field-value ur-flex-1"><input type="text" class="components-text-control__input urcr-condition-value-input urcr-condition-value-text urcr-form-field-value-input" placeholder="Enter value"></div>'),u.find(".urcr-form-field-value-input").off("input").on("input",function(){o.updateURFormFieldValue(n)})),o.updateURFormFieldValue(n)}),u.find(".urcr-add-field-button").off("click").on("click",function(e){e.preventDefault(),e.stopPropagation();var r=t.find(".urcr-form-field-row").length;o.renderFormFieldRow(t,{field_name:"",operator:"is",value:""},r,a,n),o.updateURFormFieldValue(n)}),u.find(".urcr-remove-field-button").off("click").on("click",function(r){if(r.preventDefault(),r.stopPropagation(),t.find(".urcr-form-field-row").length>1&&!e(this).prop("disabled")){u.remove();var i=t.find(".urcr-form-field-row").length;t.find(".urcr-remove-field-button").prop("disabled",i<=1),o.updateURFormFieldValue(n)}});var p=t.find(".urcr-form-field-row").length<=1;t.find(".urcr-remove-field-button").prop("disabled",p)},updateURFormFieldValue:function(t){var r=e('.urcr-condition-wrapper[data-condition-id="'+t+'"] .urcr-ur-form-field-condition');if(r.length){var i=r.find(".urcr-form-select").val()||"",a=[];r.find(".urcr-form-field-row").each(function(){var t=e(this).find(".urcr-form-field-select").val()||"",r=e(this).find(".urcr-form-field-operator-select").val()||"is",i=e(this).find(".urcr-form-field-value-input"),n=i.length&&"empty"!==r&&"not empty"!==r?i.val():"";t&&a.push({field_name:t,operator:r,value:n})});var n={form_id:i,form_fields:a},o=this.conditions.find(function(e){return e.id===t});o&&(o.value=n)}},getSelect2Options:function(e){var t=this,r=[];if("roles"===e)urcr_membership_access_data.wp_roles&&(r=Object.keys(urcr_membership_access_data.wp_roles).map(function(e){return{id:e,text:urcr_membership_access_data.wp_roles[e]}}));else if("membership"===e)if(t.membershipId>0){var i="";urcr_membership_access_data.memberships&&urcr_membership_access_data.memberships[t.membershipId]&&(i=urcr_membership_access_data.memberships[t.membershipId]),r=[{id:t.membershipId.toString(),text:i||"Current Membership"}]}else urcr_membership_access_data.memberships&&(r=Object.keys(urcr_membership_access_data.memberships).map(function(e){return{id:e,text:urcr_membership_access_data.memberships[e]}}));else"capabilities"===e?urcr_membership_access_data.wp_capabilities&&(r=Object.keys(urcr_membership_access_data.wp_capabilities).map(function(e){return{id:e,text:urcr_membership_access_data.wp_capabilities[e]}})):"registration_source"===e?urcr_membership_access_data.registration_sources&&(r=Object.keys(urcr_membership_access_data.registration_sources).map(function(e){return{id:e,text:urcr_membership_access_data.registration_sources[e]}})):"ur_form_field"===e?r=[]:"payment_status"===e&&urcr_membership_access_data.payment_status&&(r=Object.keys(urcr_membership_access_data.payment_status).map(function(e){return{id:e,text:urcr_membership_access_data.payment_status[e]}}));return r},removeCondition:function(t){e('.urcr-condition-wrapper[data-condition-id="'+t+'"]').remove(),this.conditions=this.conditions.filter(function(e){return e.id!==t})},updateConditionType:function(t,r){var i=this,a=i.getConditionOptions().find(function(e){return e.value===r});if(a){var n=e('.urcr-condition-wrapper[data-condition-id="'+t+'"]').find(".urcr-condition-value"),o=i.getConditionValueInputHtml(t,a.type,r,"",!1);n.html(o),i.initConditionSelect2(t,a.type,"");var s=i.conditions.find(function(e){return e.id===t});s&&(s.type=r,s.value="")}},updateConditionValue:function(t,r){var i="";if(e('.urcr-condition-wrapper[data-condition-id="'+t+'"] .urcr-ur-form-field-condition').length)this.updateURFormFieldValue(t);else{if(r.is("select"))i=r.is("[multiple]")?r.val()||[]:r.val()||"";else if(r.is('input[type="radio"]')){i=r.closest(".urcr-condition-wrapper").find('input[type="radio"]:checked').val()||""}else i=(r.is('input[type="number"]')||r.is('input[type="text"]')||r.is('input[type="date"]'),r.val()||"");var a=this.conditions.find(function(e){return e.id===t});a&&(a.value=i)}},addContentTarget:function(t,r,i){var a=this;i||(i="x"+Date.now()+"_"+a.targetCounter++);var n=a.getContentTypeLabel(t),o=a.getContentTargetHtml(i,t,n,r||"");e(".urcr-target-type-group").append(o),a.initContentTargetSelect2(i,t,r),a.contentTargets.push({id:i,type:t,value:r||("whole_site"===t?"whole_site":[])})},getContentTargetHtml:function(e,t,r,i){var a="";"whole_site"===t?a='<span data-content-type="whole_site" data-field-type="whole_site">'+(r||"Whole Site")+"</span>":a="pages"===t||"posts"===t?'<select class="urcr-enhanced-select2 urcr-content-target-input" multiple data-target-id="'+e+'" data-content-type="'+t+'"></select>':"taxonomy"===t?'<div class="urcr-taxonomy-select-group"><select class="urcr-taxonomy-select" data-target-id="'+e+'"><option value="">Select Taxonomy</option></select><select class="urcr-enhanced-select2 urcr-content-target-input" multiple data-target-id="'+e+'" data-content-type="taxonomy"></select></div>':'<select class="urcr-enhanced-select2 urcr-content-target-input" multiple data-target-id="'+e+'" data-content-type="'+t+'"></select>';return'<div class="urcr-target-item" data-target-id="'+e+'"><span class="urcr-target-type-label">'+("whole_site"===t?"Includes":r)+":</span>"+a+'<button type="button" class="button-link urcr-target-remove" aria-label="Remove"><span class="dashicons dashicons-no-alt"></span></button></div>'},initContentTargetSelect2:function(t,r,i){var a=e('.urcr-target-item[data-target-id="'+t+'"] .urcr-content-target-input');if(a.length&&"whole_site"!==r){var n=this.getContentTargetOptions(r);a.hasClass("select2-hidden-accessible")&&a.select2("destroy"),a.select2({data:n,multiple:!0,width:"100%"}),setTimeout(function(){i&&Array.isArray(i)&&i.length>0?a.val(i).trigger("change"):i&&!Array.isArray(i)&&"object"==typeof i&&i.value?Array.isArray(i.value)&&i.value.length>0&&a.val(i.value).trigger("change"):i&&!Array.isArray(i)&&a.val([i]).trigger("change")},50)}"taxonomy"===r&&this.initTaxonomySelect(t,i)},initTaxonomySelect:function(t,r){var i=this,a=e('.urcr-target-item[data-target-id="'+t+'"] .urcr-taxonomy-select'),n=e('.urcr-target-item[data-target-id="'+t+'"] .urcr-content-target-input');if(a.length&&urcr_membership_access_data.taxonomies){a.find("option").length<=1&&Object.keys(urcr_membership_access_data.taxonomies).forEach(function(e){a.append('<option value="'+e+'">'+urcr_membership_access_data.taxonomies[e]+"</option>")});var o=null,s=[];if(r&&r.taxonomy)o=r.taxonomy,s=r.value||[];else{o=a.val();var c=n.attr("data-value");if(c)try{s=JSON.parse(c)}catch(e){s=[]}}o&&(a.val()!==o&&a.val(o),i.updateTaxonomyTerms(t,o,s)),a.off("change").on("change",function(){var r=e(this).val();i.updateTaxonomyTerms(t,r,[])})}},updateTaxonomyTerms:function(t,r,i){var a=e('.urcr-target-item[data-target-id="'+t+'"] .urcr-content-target-input');if(a.length&&r&&urcr_membership_access_data.terms_list&&urcr_membership_access_data.terms_list[r]){var n=urcr_membership_access_data.terms_list[r],o=Object.keys(n).map(function(e){return{id:e,text:n[e]}});a.hasClass("select2-hidden-accessible")&&a.select2("destroy"),a.empty().select2({data:o,multiple:!0,width:"100%"}),i&&i.length>0&&setTimeout(function(){var e=i.map(function(e){return String(e)});a.val(e).trigger("change")},50)}},getContentTargetOptions:function(e){var t=[];return"pages"===e&&urcr_membership_access_data.pages?t=Object.keys(urcr_membership_access_data.pages).map(function(e){return{id:e,text:urcr_membership_access_data.pages[e]}}):"posts"===e&&urcr_membership_access_data.posts?t=Object.keys(urcr_membership_access_data.posts).map(function(e){return{id:e,text:urcr_membership_access_data.posts[e]}}):"post_types"===e&&urcr_membership_access_data.post_types&&(t=Object.keys(urcr_membership_access_data.post_types).map(function(e){return{id:e,text:urcr_membership_access_data.post_types[e]}})),t},removeContentTarget:function(t){var r=e('.urcr-target-item[data-target-id="'+t+'"]');r.length&&(r.removeClass("ur-d-flex").addClass("ur-d-none"),r.remove()),this.contentTargets=this.contentTargets.filter(function(e){return e.id!==t})},showContentTypeDropdown:function(t){var r=this.contentTargets.map(function(e){return e.type}),i=urcr_membership_access_data.is_pro||!1,a=urcr_membership_access_data.content_type_options,n=i?a:a.filter(function(e){return"posts"===e.value||"pages"===e.value||"whole_site"===e.value}),o=t.closest(".urcr-content-dropdown-wrapper");if(0===o.length&&(o=t.closest(".urcr-target-selection-section").find(".urcr-content-dropdown-wrapper")),0===o.length&&(o=t.closest(".urcr-target-selection-wrapper").find(".urcr-content-dropdown-wrapper")),0!==o.length){var s=o.find(".urcr-content-type-dropdown-menu");0===s.length&&(s=e('<div class="urcr-content-type-dropdown-menu urcr-dropdown-menu"></div>'),o.append(s)),s.empty(),n.forEach(function(e){var t=-1!==r.indexOf(e.value),i=t?"urcr-dropdown-option-disabled":"",a=t?'aria-disabled="true"':"",n=t?"-1":"0";s.append('<span role="button" tabindex="'+n+'" class="urcr-dropdown-option urcr-content-type-option '+i+'" data-content-type="'+e.value+'" '+a+">"+e.label+"</span>")}),s.hasClass("ur-d-none")?s.removeClass("ur-d-none").addClass("ur-d-flex"):s.removeClass("ur-d-flex").addClass("ur-d-none")}},updateAccessControlClass:function(){var t=e(".urcr-condition-value-input-wrapper");t.removeClass("urcr-restrict-content"),t.addClass("urcr-access-content")},initSelect2:function(){},getConditionOptions:function(){var e=urcr_membership_access_data.condition_options||[];return urcr_membership_access_data.is_pro||!1||(e=e.filter(function(e){return"membership"===e.value||"roles"===e.value||"user_state"===e.value})),e=e.filter(function(e){return"membership"!==e.value})},getContentTypeLabel:function(e){for(var t=urcr_membership_access_data.content_type_options||[],r=0;r<t.length;r++)if(t[r].value===e)return t[r].label||e;return e},prepareRuleData:function(){var t=this,r=e("#ur-input-type-membership-name").closest("form").find('input[name="membership_id"]');if(r.length&&r.val()&&(t.membershipId=parseInt(r.val(),10)),!t.membershipId&&window.location.search){var i=new URLSearchParams(window.location.search).get("post_id");i&&(t.membershipId=parseInt(i,10))}var a=!1;e(".urcr-condition-wrapper").each(function(){if("membership"===e(this).find(".urcr-condition-field-select").val())return a=!0,!1});var n=[];e(".urcr-condition-wrapper").each(function(){var r=e(this),i=r.data("condition-id"),a=r.find(".urcr-condition-field-select").val(),o="";if("ur_form_field"===a){var s=t.conditions.find(function(e){return e.id===i});if(s&&s.value&&"object"==typeof s.value)o=s.value;else if(r.find(".urcr-ur-form-field-condition").length){t.updateURFormFieldValue(i);var c=t.conditions.find(function(e){return e.id===i});o=c&&c.value?c.value:{form_id:"",form_fields:[]}}else o={form_id:"",form_fields:[]}}else{var l=r.find(".select2-hidden-accessible");if(l.length)o=l.val()||[],Array.isArray(o)||(o=o?[o]:[]);else{var d=r.find(".urcr-condition-value-input");if(d.is("select[multiple]")){var u=d.val();o=Array.isArray(u)?u:u?[u]:[]}else if(d.is('input[type="radio"]'))o=r.find('input[type="radio"]:checked').val()||"";else if(r.find(".urcr-period-input-group").length){var p=r.find(".urcr-period-input-group");o={select:p.find('[data-period-part="select"]').val()||"During",input:p.find('[data-period-part="input"]').val()||""}}else o=d.val()||""}}"membership"===a&&t.membershipId>0&&(o=[t.membershipId.toString()]),n.push({id:i,type:a,value:o})}),!a&&t.membershipId>0&&n.unshift({id:"x"+Date.now(),type:"membership",value:[t.membershipId.toString()]});var o=[];e(".urcr-target-item").each(function(){var t=e(this),r=t.data("target-id"),i="",a=t.find("[data-content-type]");if(a.length&&(i=a.first().data("content-type")||""),!i)if(t.find(".urcr-taxonomy-select").length)i="taxonomy";else if(t.find(".urcr-content-target-input").length)i=t.find(".urcr-content-target-input").data("content-type")||"";else{var n=t.find(".urcr-target-type-label");n.length&&-1!==n.text().indexOf("Whole Site")&&(i="whole_site")}var s="";switch(i){case"whole_site":s="whole_site";break;case"taxonomy":var c=t.find(".urcr-taxonomy-select").val(),l=t.find(".urcr-content-target-input"),d=[],u=l.attr("data-value");if(u)try{d=JSON.parse(u)}catch(e){d=[]}else d=l.val()||[];Array.isArray(d)||(d=d?[d]:[]),s={taxonomy:c,value:d};break;case"pages":case"posts":var p=[],m=(f=t.find(".urcr-content-target-input")).attr("data-value");if(m)try{p=JSON.parse(m)}catch(e){p=[]}else p=f.val()||[];s=Array.isArray(p)?p:p?[p]:[];break;default:var f,h=[],v=(f=t.find(".urcr-content-target-input")).attr("data-value");if(v)try{h=JSON.parse(v)}catch(e){h=[]}else h=f.val()||[];s=Array.isArray(h)?h:h?[h]:[]}switch(i){case"pages":i="wp_pages";break;case"posts":i="wp_posts"}var g={id:r,type:i};"whole_site"!==i&&(g.value=s),o.push(g)});var s=t.getActionsFromForm(),c={title:"",access_rule_data:{enabled:!0,access_control:t.accessControl||"access",logic_map:{type:"group",id:"x"+Date.now(),conditions:n,logic_gate:"AND"},target_contents:o,actions:s},rule_type:"membership",membership_id:t.membershipId};return e("#urcr-membership-access-rule-data").val(JSON.stringify(c)),window.urcrMembershipAccessRuleData=c,c},initActionSection:function(){var t=e("#urcr-membership-action-type");if(e(".urcr-action-input-container").removeClass("ur-d-flex").addClass("ur-d-none"),t.length){e(".urcr-action-local-page, .urcr-action-ur-form, .urcr-action-shortcode-tag").each(function(){e(this).hasClass("select2-hidden-accessible")||e(this).select2({width:"100%"})});var r=t.val()||"message";this.handleActionTypeChange(r)}var i=e('input[name="urcr-membership-message-type"]');if(i.length){var a=i.filter(":checked");a.length||(i.filter('[value="global"]').prop("checked",!0),a=i.filter('[value="global"]')),a.trigger("change")}else{var n=e(".urcrra-message-input-container");n.length&&(n.removeClass("ur-d-flex").addClass("ur-d-none"),n.hide())}},handleActionTypeChange:function(t){e(".urcr-action-input-container").removeClass("ur-d-flex").addClass("ur-d-none"),t||(t="message");var r=null;switch(t){case"message":default:r=e(".urcrra-message-input-container");break;case"redirect":r=e(".urcrra-redirect-input-container");break;case"local_page":r=e(".urcrra-redirect-to-local-page-input-container");break;case"ur-form":r=e(".urcrra-ur-form-input-container");break;case"shortcode":r=e(".urcrra-shortcode-input-container")}r&&r.length&&r.removeClass("ur-d-none").addClass("ur-d-flex")},getActionsFromForm:function(){var t=e("#urcr-membership-action-type");if(!t.length)return this.getDefaultActions();var r=t.val()||"message",i={id:"x"+Date.now(),type:r,access_control:this.accessControl||"access"};switch(r){case"message":i.label="Show Message";var a=e('input[name="urcr-membership-message-type"]:checked'),n="";if("global"===(a.length?a.val():"global"))n="";else if("undefined"!=typeof wp&&wp.editor&&e("#urcr-membership-action-message").length){var o=window.tinymce&&window.tinymce.get("urcr-membership-action-message");n=o?o.getContent():wp.editor.getContent("urcr-membership-action-message")}else n=e("#urcr-membership-action-message").val()||"";i.message=n?encodeURIComponent(n):"",i.redirect_url="",i.local_page="",i.ur_form="",i.shortcode={tag:"",args:""};break;case"redirect":i.label="Redirect",i.message="",i.redirect_url=e(".urcr-action-redirect-url").val()||"",i.local_page="",i.ur_form="",i.shortcode={tag:"",args:""};break;case"local_page":i.type="redirect_to_local_page",i.label="Redirect to a Local Page",i.message="",i.redirect_url="",i.local_page=e(".urcr-action-local-page").val()||"",i.ur_form="",i.shortcode={tag:"",args:""};break;case"ur-form":i.type="ur-form",i.label="Show UR Form",i.message="",i.redirect_url="",i.local_page="",i.ur_form=e(".urcr-action-ur-form").val()||"",i.shortcode={tag:"",args:""};break;case"shortcode":i.label="Render Shortcode",i.message="",i.redirect_url="",i.local_page="",i.ur_form="",i.shortcode={tag:e(".urcr-action-shortcode-tag").val()||"",args:e(".urcr-action-shortcode-args").val()||""}}return[i]},getDefaultActions:function(){return[{id:"x"+Date.now(),type:"message",label:"Show Message",message:"<h3>Membership Required</h3>\n<p>This content is available to members only.</p>\n<p>Sign up to unlock access or log in if you already have an account.</p>\n<p>{{sign_up}} {{log_in}}</p>",redirect_url:"",access_control:this.accessControl,local_page:"",ur_form:"",shortcode:{tag:"",args:""}}]}};e(document).ready(function(){0===e("#ur-membership-access-section").length?setTimeout(function(){e("#ur-membership-access-section").length>0&&t.init()},500):t.init()}),window.URCRMembershipAccess=t}(jQuery);